import{_ as e,x as a,r as t,a as s,h as l,w as n,i as o,o as i,b as c,f as r,c as u,k as d,F as p,U as m,n as f,p as h,af as _,q as v,D as y,S as g,N as b,C as k,t as w,j as D}from"./index-BBHsMkl9.js";import{_ as S}from"./uni-icons.CHT_tfDp.js";import{r as j}from"./uni-app.es.DcEqF3_b.js";import{_ as x}from"./uv-input.C6WEQg7_.js";import{c as C,d as z}from"./cook.Ddvzagky.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";import"./uv-icon.CNdQXE0P.js";import"./uv-icon.vue_vue_type_style_index_0_scoped_eab170a5_lang.DCSa3_gx.js";const T=A({__name:"ChatAssistant2",setup(A){const T=e.database(),U={apiKey:"",apiUrl:"https://dashscope.aliyuncs.com/api/v1/apps/b3a64cafe994432d9e5993d03c104755/completion"};a((async()=>{const e=await T.collection("api").where({appid:"b3a64cafe994432d9e5993d03c104755"}).get();console.log("apikey：",e.result.data[0].apikey);const a=e.result.data[0].apikey;U.apiKey=a}));const I=t([{role:"assistant",content:"您好！我是东方夜雀食堂AI助手，如果您对游戏中的料理、人物、玩法感兴趣，请尽管问我~",timestamp:new Date}]),K=t(""),N=t(!1),O=e=>{if(!e)return"";return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},V=async()=>{var e;if(!K.value.trim()||N.value)return;const a={role:"user",content:K.value.trim(),timestamp:new Date};I.value.push(a);const t=m({role:"assistant",content:"",loading:!0,timestamp:new Date});I.value.push(t),K.value="",N.value=!0;try{const l=(await fetch(U.apiUrl,{method:"POST",headers:{Authorization:`Bearer ${U.apiKey}`,"Content-Type":"application/json","X-DashScope-SSE":"enable"},body:JSON.stringify({input:{prompt:a.content},parameters:{incremental_output:!0},debug:{}})})).body.getReader(),n=new TextDecoder;let o="";for(;;){const{done:a,value:i}=await l.read();if(a)break;o+=n.decode(i,{stream:!0});const c=o.split(/\n\n/);o=c.pop()||"";for(const l of c){const a=l.split("\n");for(const l of a)if(l.startsWith("data:"))try{const a=(null==(e=JSON.parse(l.slice(5).trim()).output)?void 0:e.text)||"";if(a)for(const e of a)t.content+=e,await f(),await new Promise((e=>setTimeout(e,20)))}catch(s){console.error("解析失败:",s)}}await f(),h({selector:"#msg-"+(I.value.length-1),duration:300})}}catch(l){console.error("请求失败:",l),t.content="抱歉，回答生成失败，请稍后再试。"}finally{N.value=!1,t.loading=!1,t.timestamp=new Date;const{matchedDishes:e,matchedDrinks:a}=B(t.content);t.matchedDishes=e,t.matchedDrinks=a}},$=()=>{_({url:"/"+v().pop().route})},B=e=>{const a=C()||[],t=z()||[],s=[...new Set(e.match(/\[[^\[\]]+?\]/g)||[])].map((e=>e.replace(/[\[\]]/g,"").trim())).filter(Boolean),l=[],n=[];return s.forEach((e=>{const s=a.find((a=>a.chinese===e)),o=t.find((a=>a.chinese===e));s&&l.push(s),o&&n.push(o)})),{matchedDishes:l,matchedDrinks:n}};return(e,a)=>{const t=y,m=j(s("uni-icons"),S),f=o,h=g,_=j(s("uv-input"),x),v=b;return i(),l(f,{class:"chat-container"},{default:n((()=>[c(f,{class:"chat-header"},{default:n((()=>[c(t,null,{default:n((()=>[r("夜雀AI助手")])),_:1}),c(m,{type:"close",size:"24",onClick:$})])),_:1}),c(h,{class:"chat-messages","scroll-y":"true","scroll-into-view":"msg-"+(I.value.length-1),"scroll-with-animation":!0},{default:n((()=>[(i(!0),u(p,null,d(I.value,((e,a)=>(i(),l(f,{id:"msg-"+a,key:a,class:k(["message-bubble",e.role])},{default:n((()=>{var a,s;return[c(f,{class:"message-content"},{default:n((()=>[r(w(e.content),1)])),_:2},1024),c(f,{class:"message-time"},{default:n((()=>[r(w(O(e.timestamp)),1)])),_:2},1024),(null==(a=e.matchedDishes)?void 0:a.length)?(i(),l(f,{key:0,class:"dish-cards"},{default:n((()=>[(i(!0),u(p,null,d(e.matchedDishes,((e,a)=>(i(),l(f,{key:a,class:"dish-card"},{default:n((()=>[c(t,{class:"dish-title"},{default:n((()=>[r(w(e.chinese),1)])),_:2},1024),c(f,{class:"dish-info"},{default:n((()=>[c(t,null,{default:n((()=>[r("🍳 材料："+w(e.material),1)])),_:2},1024),c(t,null,{default:n((()=>[r("💰 售价："+w(e.money)+"文",1)])),_:2},1024),c(t,null,{default:n((()=>[r("⏳ 等级："+w(e.level)+"级",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)):D("",!0),(null==(s=e.matchedDrinks)?void 0:s.length)?(i(),l(f,{key:1,class:"drink-cards"},{default:n((()=>[(i(!0),u(p,null,d(e.matchedDrinks,((e,a)=>(i(),l(f,{key:a,class:"drink-card"},{default:n((()=>[c(t,{class:"drink-title"},{default:n((()=>[r(w(e.chinese),1)])),_:2},1024),c(f,{class:"drink-info"},{default:n((()=>[c(t,null,{default:n((()=>[r("🧃 特性："+w(e.tag),1)])),_:2},1024),c(t,null,{default:n((()=>[r("💰 售价："+w(e.money)+"文",1)])),_:2},1024),c(t,null,{default:n((()=>[r("⏳ 等级："+w(e.level)+"级",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)):D("",!0)]})),_:2},1032,["id","class"])))),128))])),_:1},8,["scroll-into-view"]),c(f,{class:"chat-input-area"},{default:n((()=>[c(_,{modelValue:K.value,"onUpdate:modelValue":a[0]||(a[0]=e=>K.value=e),placeholder:"输入消息...",border:"none",bgColor:"#fbefcb",disabled:N.value,class:"chat-input"},null,8,["modelValue","disabled"]),c(v,{onClick:V,disabled:N.value||!K.value.trim(),class:"send-button"},{default:n((()=>[c(m,{type:N.value?"spinner-cycle":"paperplane",size:"20",color:N.value||!K.value.trim()?"#aaa":"#fff"},null,8,["type","color"])])),_:1},8,["disabled"])])),_:1})])),_:1})}}},[["__scopeId","data-v-f5df771b"]]);export{T as default};
